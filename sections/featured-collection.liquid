{% liquid
  assign products_to_display = section.settings.collection.all_products_count

  if section.settings.collection.all_products_count > section.settings.products_to_show
    assign products_to_display = section.settings.products_to_show
    assign more_in_collection = true
  endif

  assign columns_mobile_int = section.settings.columns_mobile | plus: 0
  assign show_mobile_slider = false
  if section.settings.swipe_on_mobile and products_to_display > columns_mobile_int
    assign show_mobile_slider = true
  endif

  assign show_desktop_slider = false
  if section.settings.enable_desktop_slider and products_to_display > section.settings.columns_desktop
    assign show_desktop_slider = true
  endif

  assign columns_desktop = section.settings.columns_desktop
  assign columns_tablet = columns_desktop
  if columns_desktop > 3
    assign columns_tablet = columns_desktop | divided_by: 2.0 | ceil
  endif
  
  assign motion_delay = 50
%}

{%- style -%}
  /* --- 1. RESET GRID CONTAINER --- */
  .auragems-product-grid {
    display: grid;
    /* Dùng minmax(0, 1fr) để bắt buộc các cột bằng nhau bất kể nội dung to hay nhỏ */
    grid-template-columns: repeat({{ columns_mobile_int }}, minmax(0, 1fr));
    gap: 10px;
    list-style: none;
    padding: 0;
    margin: 0;
    width: 100%;
  }

  /* --- 2. LOGIC SLIDER (FLEXBOX) --- */
  .auragems-product-grid.slider-active {
    display: flex;
    flex-wrap: nowrap;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    padding-bottom: 20px;
  }
  .auragems-product-grid.slider-active::-webkit-scrollbar { display: none; }

  /* --- 3. PRODUCT ITEM (CỘT) - ÉP KÍCH THƯỚC CỨNG --- */
  .auragems-product-item {
    display: flex;
    flex-direction: column;
    width: 100%; 
    height: 100%;
    box-sizing: border-box;
  }

  /* Slider Mode: Tính toán độ rộng thủ công và ÉP KHÔNG ĐƯỢC CO GIÃN */
  .auragems-product-grid.slider-active .auragems-product-item {
    width: calc(100% / {{ columns_mobile_int }} - 15px);
    flex: 0 0 calc(100% / {{ columns_mobile_int }} - 15px); 
    scroll-snap-align: start;
  }

  /* --- 4. RESPONSIVE --- */
  @media screen and (min-width: 750px) {
    .auragems-product-grid { gap: 15px; }
    
    .auragems-product-grid.slider-active .auragems-product-item {
      width: calc(100% / {{ columns_desktop }} - 15px);
      flex: 0 0 calc(100% / {{ columns_desktop }} - 15px);
    }
  }

  @media screen and (min-width: 990px) {
    .auragems-product-grid {
      grid-template-columns: repeat({{ columns_desktop }}, minmax(0, 1fr));
    }
  }

  /* --- 5. CARD & IMAGE FORCING --- */
  .section-{{ section.id }} .card-wrapper {
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;
    background: rgb(var(--color-background));
    border-radius: var(--block-radius, 8px);
    overflow: hidden;
  }

  .section-{{ section.id }} .card__media {
    position: relative;
    width: 100%;
    z-index: 1;
  }

  /* ÉP KHUNG HÌNH (ASPECT RATIO) */
  .section-{{ section.id }} .card__media .media {
    display: block !important;
    position: relative !important;
    width: 100% !important;
    height: auto !important;
    padding-bottom: 0 !important;
    
    {% if section.settings.image_ratio == 'portrait' %}
      aspect-ratio: 3 / 4 !important;
    {% else %}
      aspect-ratio: 1 / 1 !important;
    {% endif %}
  }

  /* ÉP ẢNH (OBJECT FIT) */
  .section-{{ section.id }} .card__media .media img {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    object-fit: cover !important;
  }
  
  /* Các style phụ trợ */
  .section-{{ section.id }} .card__content { padding: 1rem; flex-grow: 1; display: flex; flex-direction: column; justify-content: space-between; }
  .section-{{ section.id }} .slider-btn { border: 1px solid rgba(var(--color-foreground), 0.1); width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; background: transparent; }
  .section-{{ section.id }} .slider-controls { display: flex; gap: 10px; margin-left: auto; }
{%- endstyle -%}

{% render 'divider', show_divider: section.settings.show_section_divider, divider_width: section.settings.divider_width %}

<div class="section section-{{ section.id }} section--padding color-{{ section.settings.color_scheme }} gradient"
  style="--section-padding-top: {{ section.settings.padding_top }}px;--section-padding-bottom: {{ section.settings.padding_bottom }}px;">
  
  <div class="page-width">
    <div class="section__header spacing--large md:flex justify-between items-end gap-2" style="margin-bottom: 15px;">
      <div class="rich-text text-{{ section.settings.header_alignment_mobile }} md:text-{{ section.settings.header_alignment }}">
        {%- if section.settings.subheading != blank -%}
          <motion-element class="block rich-text__subheading text-subheading" data-motion="fade-up" data-motion-delay="{{ motion_delay }}">
            {{ section.settings.subheading }}
          </motion-element>
          {%- assign motion_delay = motion_delay | plus: 50 -%}
        {%- endif -%}

        {%- if section.settings.title != blank -%}
          <h2 class="rich-text__heading inline-richtext {{ section.settings.heading_size }}">
            <motion-element class="block" data-motion="fade-up" data-motion-delay="{{ motion_delay }}">
              {% render 'highlight-text', text: section.settings.title, style: section.settings.heading_highlight_style %}
            </motion-element>
          </h2>
          {%- assign motion_delay = motion_delay | plus: 50 -%}
        {%- endif -%}

        {%- if section.settings.description != blank -%}
          <motion-element class="block rich-text__text rte {{ section.settings.description_size }}" data-motion="fade-up" data-motion-delay="{{ motion_delay }}">
            {{ section.settings.description }}
          </motion-element>
          {%- assign motion_delay = motion_delay | plus: 50 -%}
        {%- endif -%}
      </div>

      {%- if show_desktop_slider -%}
        <motion-element class="slider-controls hidden md:inline-flex" data-motion="fade-up" data-motion-delay="{{ motion_delay }}">
          <button type="button" class="slider-btn" id="Prev-{{ section.id }}" aria-label="Previous">
            {% render 'icon-slider-prev' %}
          </button>
          <button type="button" class="slider-btn" id="Next-{{ section.id }}" aria-label="Next">
            {% render 'icon-slider-next' %}
          </button>
        </motion-element>
      {%- endif -%}
    </div>

    <motion-element class="section__content block" data-motion="fade-up" data-motion-delay="{{ motion_delay }}">
      <div 
        id="Slider-{{ section.id }}"
        class="auragems-product-grid {% if show_desktop_slider or show_mobile_slider %}slider-active{% endif %}"
      >
        {%- if section.settings.collection != blank and section.settings.collection.all_products_count > 0 -%}
          {%- for product in section.settings.collection.products limit: section.settings.products_to_show -%}
            <div class="auragems-product-item">
              {% render 'card-product',
                product: product,
                media_aspect_ratio: section.settings.image_ratio,
                show_secondary_image: section.settings.show_secondary_image,
                show_vendor: section.settings.show_vendor,
                show_rating: section.settings.show_rating,
                show_quick_add: section.settings.enable_quick_add,
                section_id: section.id
              %}
            </div>
          {%- endfor -%}
        {%- else -%}
          {%- for i in (1..section.settings.products_to_show) -%}
            <div class="auragems-product-item">
              {% render 'card-product-placeholder', media_aspect_ratio: section.settings.image_ratio %}
            </div>
          {%- endfor -%}
        {%- endif -%}
      </div>
    </motion-element>

    {%- if section.settings.show_view_all and more_in_collection -%}
      <div class="section__footer">
        <a href="{{ section.settings.collection.url }}" class="btn {{ section.settings.view_all_style }}">
          {{ 'sections.featured_collection.view_all' | t }}
        </a>
      </div>
    {%- endif -%}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const slider = document.getElementById('Slider-{{ section.id }}');
    const prevBtn = document.getElementById('Prev-{{ section.id }}');
    const nextBtn = document.getElementById('Next-{{ section.id }}');

    if (slider && prevBtn && nextBtn) {
      nextBtn.addEventListener('click', () => {
        const itemWidth = slider.querySelector('.auragems-product-item').clientWidth;
        slider.scrollBy({ left: itemWidth, behavior: 'smooth' });
      });

      prevBtn.addEventListener('click', () => {
        const itemWidth = slider.querySelector('.auragems-product-item').clientWidth;
        slider.scrollBy({ left: -itemWidth, behavior: 'smooth' });
      });
    }
  });
</script>

{% schema %}
{
  "name": "Featured Collection",
  "tag": "section",
  "class": "section section-featured-collection",
  "disabled_on": {
    "groups": ["header", "footer", "custom.overlay"]
  },
  "settings": [
    {
      "type": "paragraph",
      "content": "Display products from a specific collection."
    },
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 25,
      "step": 1,
      "default": 8,
      "label": "Maximum products to show"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "inline_richtext",
      "id": "title",
      "default": "Featured Collection",
      "label": "Heading"
    },
    {
      "type": "select",
      "id": "heading_size",
      "options": [
        { "value": "h3", "label": "Small" },
        { "value": "h2", "label": "Medium" },
        { "value": "h1", "label": "Large" }
      ],
      "default": "h2",
      "label": "Heading Size"
    },
    {
      "type": "select",
      "id": "heading_highlight_style",
      "label": "Highlight Style",
      "options": [
        { "value": "none", "label": "None" },
        { "value": "underline", "label": "Underline" }
      ]
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Description"
    },
    {
      "type": "select",
      "id": "header_alignment",
      "label": "Desktop Alignment",
      "options": [
        { "value": "left", "label": "Left" },
        { "value": "center", "label": "Center" },
        { "value": "right", "label": "Right" }
      ],
      "default": "left"
    },
    {
      "type": "header",
      "content": "Grid & Slider"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Columns on Desktop"
    },
    {
      "type": "checkbox",
      "id": "enable_desktop_slider",
      "label": "Enable Slider on Desktop",
      "default": true
    },
    {
      "type": "select",
      "id": "column_gap",
      "options": [
        { "value": "medium", "label": "Medium" },
        { "value": "large", "label": "Large" }
      ],
      "default": "medium",
      "label": "Column Gap"
    },
    {
      "type": "header",
      "content": "Product Card"
    },
    {
      "type": "select",
      "id": "image_ratio",
      "options": [
        { "value": "square", "label": "Square (1:1)" },
        { "value": "portrait", "label": "Portrait (3:4)" },
        { "value": "adapt", "label": "Adapt to image (Not Fixed)" }
      ],
      "default": "square",
      "label": "Image Ratio"
    },
    {
      "type": "checkbox",
      "id": "show_secondary_image",
      "default": false,
      "label": "Show second image on hover"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    },
    {
      "type": "checkbox",
      "id": "show_rating",
      "default": false,
      "label": "Show product rating"
    },
    {
      "type": "checkbox",
      "id": "enable_quick_add",
      "default": true,
      "label": "Enable Quick Add Button"
    },
    {
      "type": "header",
      "content": "Mobile Settings"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "options": [
        { "value": "1", "label": "1 Column" },
        { "value": "2", "label": "2 Columns" }
      ],
      "default": "2",
      "label": "Columns on Mobile"
    },
    {
      "type": "checkbox",
      "id": "swipe_on_mobile",
      "default": true,
      "label": "Enable Swipe on Mobile"
    },
    {
      "type": "header",
      "content": "View All Button"
    },
    {
      "type": "checkbox",
      "id": "show_view_all",
      "default": true,
      "label": "Show 'View all' button"
    },
    {
      "type": "select",
      "id": "view_all_style",
      "label": "Button Style",
      "options": [
        { "value": "btn--primary", "label": "Primary" },
        { "value": "btn--secondary", "label": "Secondary" },
        { "value": "btn--outline", "label": "Outline" }
      ],
      "default": "btn--outline"
    },
    {
      "type": "header",
      "content": "Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top Padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 36
    },
    {
      "type": "checkbox",
      "id": "show_section_divider",
      "label": "Show Divider",
      "default": false
    },
    {
      "type": "select",
      "id": "divider_width",
      "options": [
        { "value": "fixed", "label": "Fixed" },
        { "value": "full", "label": "Full" }
      ],
      "default": "fixed",
      "label": "Divider Width"
    }
  ],
  "presets": [
    {
      "name": "Featured Collection (Auragems)"
    }
  ]
}
{% endschema %}
{{ 'collection.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign columns_desktop = section.settings.columns_desktop
  assign columns_tablet = 3
  assign columns_mobile = section.settings.columns_mobile | times: 1
  assign default_grid_mobile = 'f-grid-' | append: columns_mobile | append: '-cols'

  assign is_metro = false
  if section.settings.grid_layout == 'metro'
    assign is_metro = true
  endif
-%}

{%- if is_metro -%}
  {%- render 'product-grid-metro-style',
    section_id: section.id,
    desktop_breakpoint: 1280,
    columns_desktop: columns_desktop,
    columns_tablet: columns_tablet,
    columns_mobile: columns_mobile
  -%}
{%- endif -%}

{%- capture image_sizes -%}
(max-width: 767px) calc((100vw - 38px) / {{ columns_mobile }}),
(max-width: 1279px) calc((100vw - 90px) / {{ columns_tablet }}),
{{ settings.page_width | divided_by: columns_desktop }}px
{%- endcapture -%}

{% render 'divider',
  show_divider: section.settings.show_section_divider,
  divider_width: section.settings.divider_width
%}

<div
  class="section--padding color-{{ section.settings.color_scheme }}"
  style="--section-padding-top: {{ section.settings.padding_top }}px;--section-padding-bottom: {{ section.settings.padding_bottom }}px;"
>
  <div class="collection page-width">
    {%- paginate collection.products by section.settings.products_per_page -%}
      <div class="collection__content flex flex-col">
        
        <div class="collection-header text-left" style="margin-bottom: 15px; width: 100%;">
          <p class="collection-count" style="margin: 0; font-size: 14px; opacity: 0.8;">
            Showing {{ collection.products.size }} of {{ collections['all'].all_products_count }} products
          </p>
        </div>

        <div class="flex flex-col flex-grow" id="ProductGridWrapper">
          
          <div id="ProductGridContainer">
            <grid-list
              id="ProductsList"
              class="grid-list products-list f-grid md:f-grid-{{ columns_tablet }}-cols xl:f-grid-{{ columns_desktop }}-cols {{ default_grid_mobile }} f-grid--gap-medium"
            >
              
              {%- assign displayed_products = "|" -%}

              {% comment %} --- PHẦN 1: SẢN PHẨM TRONG COLLECTION --- {% endcomment %}
              {%- for product in collection.products -%}
                {%- assign displayed_products = displayed_products | append: product.handle | append: "|" -%}
                <div class="f-column card">
                  {%- if is_metro -%}
                    {%- render 'card-product-metro',
                      product: product,
                      image_sizes: image_sizes,
                      section_id: section.id,
                      section_index: 2,
                      index: forloop.index,
                      index0: forloop.index0,
                      desktop_breakpoint: 1280,
                      columns_desktop: columns_desktop,
                      columns_tablet: columns_tablet,
                      columns_mobile: columns_mobile
                    -%}
                  {%- else -%}
                    {%- render 'card-product',
                      product: product,
                      image_sizes: image_sizes,
                      section_id: section.id,
                      section_index: 2,
                      index: forloop.index
                    -%}
                  {%- endif -%}
                </div>
              {%- endfor -%}

              {% comment %} --- PHẦN 2: SẢN PHẨM BỔ SUNG (GIÁ THẤP -> CAO) --- {% endcomment %}
              {%- if paginate.current_page == paginate.pages or paginate.pages == 0 -%}
                {%- assign other_products = collections['all'].products | sort: 'price' -%}
                {%- assign counter = 0 -%}
                
                {% comment %} 
                  Tính toán số lượng cần bổ sung để đủ lưới (đẹp đội hình)
                  Ví dụ: Trang cần 12, collection có 5 -> Bổ sung 7
                {% endcomment %}
                {%- assign items_needed = section.settings.products_per_page | minus: collection.products.size -%}
                
                {% comment %} Nếu collection đã đủ hoặc thừa thì không bổ sung, ngược lại thì lấy tối đa limit_extra {% endcomment %}
                {%- if items_needed > 0 -%}
                    {%- assign limit_extra = items_needed -%}
                {%- else -%}
                    {%- assign limit_extra = 0 -%}
                {%- endif -%}

                {%- for product in other_products -%}
                  {%- assign check_handle = "|" | append: product.handle | append: "|" -%}
                  
                  {%- unless displayed_products contains check_handle -%}
                    {%- if counter < limit_extra -%}
                      <div class="f-column card">
                        {%- if is_metro -%}
                          {%- render 'card-product-metro',
                            product: product,
                            image_sizes: image_sizes,
                            section_id: section.id,
                            section_index: 2,
                            index: forloop.index,
                            index0: forloop.index0,
                            desktop_breakpoint: 1280,
                            columns_desktop: columns_desktop,
                            columns_tablet: columns_tablet,
                            columns_mobile: columns_mobile
                          -%}
                        {%- else -%}
                          {%- render 'card-product',
                            product: product,
                            image_sizes: image_sizes,
                            section_id: section.id,
                            section_index: 2,
                            index: forloop.index
                          -%}
                        {%- endif -%}
                      </div>
                      {%- assign counter = counter | plus: 1 -%}
                    {%- endif -%}
                  {%- endunless -%}
                {%- endfor -%}
              {%- endif -%}

            </grid-list>

            {%- liquid
              if paginate.pages > 1
                render 'pagination', paginate: paginate, type: section.settings.pagination
              endif
            -%}
          </div>
        </div>
      </div>
    {%- endpaginate -%}
  </div>
</div>

{% schema %}
{
  "name": "Mix Price (3 Cols)",
  "class": "collection-section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Cấu hình hiển thị lưới sản phẩm."
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 12,
      "max": 50,
      "step": 1,
      "default": 12,
      "label": "Products per page (Số lượng/Trang)",
      "info": "Mặc định 12 để có 4 hàng."
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 3,
      "label": "Columns on Desktop (Số cột)",
      "info": "Chọn 3 cột để hiển thị to rõ."
    },
    {
      "type": "select",
      "id": "pagination",
      "label": "Pagination Type",
      "options": [
        { "value": "infinite", "label": "Infinite Scroll" },
        { "value": "load_more", "label": "Load More Button" },
        { "value": "number", "label": "Page Numbers" }
      ],
      "default": "number"
    },
    {
        "type": "header",
        "content": "Layout & Spacing"
    },
    {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 2,
        "unit": "px",
        "label": "Padding Top",
        "default": 50
    },
    {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 2,
        "unit": "px",
        "label": "Padding Bottom",
        "default": 50
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color scheme",
      "default": "scheme-1"
    },
    {
      "type": "select",
      "id": "grid_layout",
      "options": [
        { "value": "standard", "label": "Standard" },
        { "value": "metro", "label": "Metro" }
      ],
      "default": "standard",
      "label": "Grid layout"
    },
    {
      "type": "select",
      "id": "columns_mobile",
      "default": "2",
      "label": "Columns on Mobile",
      "options": [
        { "value": "1", "label": "1 Column" },
        { "value": "2", "label": "2 Columns" }
      ]
    },
    {
      "type": "checkbox",
      "id": "show_section_divider",
      "default": false,
      "label": "Show divider"
    },
    {
      "type": "select",
      "id": "divider_width",
      "options": [
        { "value": "fixed", "label": "Fixed" },
        { "value": "full", "label": "Full" }
      ],
      "default": "fixed",
      "label": "Divider width"
    }
  ]
}
{% endschema %}
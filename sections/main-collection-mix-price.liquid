{{ 'collection.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign columns_desktop = section.settings.columns_desktop
  assign columns_tablet = 3
  assign columns_mobile = section.settings.columns_mobile | times: 1
  assign default_grid_mobile = 'f-grid-' | append: columns_mobile | append: '-cols'

  assign is_metro = false
  if section.settings.grid_layout == 'metro'
    assign is_metro = true
  endif
-%}

{%- if is_metro -%}
  {%- render 'product-grid-metro-style',
    section_id: section.id,
    desktop_breakpoint: 1280,
    columns_desktop: columns_desktop,
    columns_tablet: columns_tablet,
    columns_mobile: columns_mobile
  -%}
{%- endif -%}

{%- capture image_sizes -%}
(max-width: 767px) calc((100vw - 38px) / {{ columns_mobile }}),
(max-width: 1279px) calc((100vw - 90px) / {{ columns_tablet }}),
{{ settings.page_width | divided_by: columns_desktop }}px
{%- endcapture -%}

{% render 'divider',
  show_divider: section.settings.show_section_divider,
  divider_width: section.settings.divider_width
%}

<div
  class="section--padding color-{{ section.settings.color_scheme }}"
  style="--section-padding-top: {{ section.settings.padding_top }}px;--section-padding-bottom: {{ section.settings.padding_bottom }}px;"
>
  <div class="collection page-width">
    {%- paginate collection.products by section.settings.products_per_page -%}
      <div class="collection__content flex flex-col">
        
        {% comment %} --- HIỂN THỊ TỔNG SỐ SẢN PHẨM --- {% endcomment %}
        <div class="collection-header text-center" style="margin-bottom: 30px;">
          <h2 class="h3">{{ collection.title }}</h2>
          <p class="collection-count">
            {{ collections['all'].all_products_count }} products
          </p>
        </div>

        <div class="flex flex-col flex-grow" id="ProductGridWrapper">
          
          <div id="ProductGridContainer">
            <grid-list
              id="ProductsList"
              class="grid-list products-list f-grid md:f-grid-{{ columns_tablet }}-cols xl:f-grid-{{ columns_desktop }}-cols {{ default_grid_mobile }} f-grid--gap-medium"
            >
              
              {%- assign displayed_products = "|" -%}

              {% comment %} --- PHẦN 1: SẢN PHẨM TRONG COLLECTION --- {% endcomment %}
              {%- for product in collection.products -%}
                {%- assign displayed_products = displayed_products | append: product.handle | append: "|" -%}
                <div class="f-column card">
                  {%- if is_metro -%}
                    {%- render 'card-product-metro',
                      product: product,
                      image_sizes: image_sizes,
                      section_id: section.id,
                      section_index: 2,
                      index: forloop.index,
                      index0: forloop.index0,
                      desktop_breakpoint: 1280,
                      columns_desktop: columns_desktop,
                      columns_tablet: columns_tablet,
                      columns_mobile: columns_mobile
                    -%}
                  {%- else -%}
                    {%- render 'card-product',
                      product: product,
                      image_sizes: image_sizes,
                      section_id: section.id,
                      section_index: 2,
                      index: forloop.index
                    -%}
                  {%- endif -%}
                </div>
              {%- endfor -%}

              {% comment %} --- PHẦN 2: SẢN PHẨM CÒN LẠI (GIÁ THẤP -> CAO) --- {% endcomment %}
              {%- if paginate.current_page == paginate.pages or paginate.pages == 0 -%}
                {%- assign other_products = collections['all'].products | sort: 'price' -%}
                {%- assign counter = 0 -%}
                {%- assign limit_extra = 24 -%} 

                {%- for product in other_products -%}
                  {%- assign check_handle = "|" | append: product.handle | append: "|" -%}
                  
                  {%- unless displayed_products contains check_handle -%}
                    {%- if counter < limit_extra -%}
                      <div class="f-column card">
                        {%- if is_metro -%}
                          {%- render 'card-product-metro',
                            product: product,
                            image_sizes: image_sizes,
                            section_id: section.id,
                            section_index: 2,
                            index: forloop.index,
                            index0: forloop.index0,
                            desktop_breakpoint: 1280,
                            columns_desktop: columns_desktop,
                            columns_tablet: columns_tablet,
                            columns_mobile: columns_mobile
                          -%}
                        {%- else -%}
                          {%- render 'card-product',
                            product: product,
                            image_sizes: image_sizes,
                            section_id: section.id,
                            section_index: 2,
                            index: forloop.index
                          -%}
                        {%- endif -%}
                      </div>
                      {%- assign counter = counter | plus: 1 -%}
                    {%- endif -%}
                  {%- endunless -%}
                {%- endfor -%}
              {%- endif -%}

            </grid-list>

            {%- liquid
              if paginate.pages > 1
                render 'pagination', paginate: paginate, type: section.settings.pagination
              endif
            -%}
          </div>
        </div>
      </div>
    {%- endpaginate -%}
  </div>
</div>

{% schema %}
{
  "name": "Mix Price (No Filter)",
  "class": "collection-section",
  "settings": [
    {
      "type": "paragraph",
      "content": "Template này đã tắt bộ lọc và hiển thị tổng số sản phẩm của toàn shop."
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:sections.all.colors.label",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "products_per_page",
      "min": 8,
      "max": 36,
      "step": 1,
      "default": 16,
      "label": "t:sections.main-collection-product-grid.settings.products_per_page.label"
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "min": 2,
      "max": 6,
      "step": 1,
      "default": 4,
      "label": "t:sections.main-collection-product-grid.settings.columns_desktop.label"
    },
    {
      "type": "select",
      "id": "grid_layout",
      "options": [
        {
          "value": "standard",
          "label": "Standard"
        },
        {
          "value": "metro",
          "label": "Metro"
        }
      ],
      "default": "standard",
      "label": "Grid layout"
    },
    {
      "type": "select",
      "id": "pagination",
      "label": "t:sections.main-collection-product-grid.settings.pagination.label",
      "options": [
        {
          "value": "infinite",
          "label": "Infinite"
        },
        {
          "value": "load_more",
          "label": "Load more"
        },
        {
          "value": "number",
          "label": "Number"
        }
      ],
      "default": "number"
    },
    {
      "type": "checkbox",
      "id": "show_section_divider",
      "default": false,
      "label": "t:sections.all.divider.settings.show_divider.label"
    },
    {
      "type": "select",
      "id": "divider_width",
      "options": [
        {
          "value": "fixed",
          "label": "Fixed"
        },
        {
          "value": "full",
          "label": "Full"
        }
      ],
      "default": "fixed",
      "label": "Divider width"
    },
    {
        "type": "header",
        "content": "Padding"
    },
    {
        "type": "range",
        "id": "padding_top",
        "min": 0,
        "max": 100,
        "step": 2,
        "unit": "px",
        "label": "Padding Top",
        "default": 50
    },
    {
        "type": "range",
        "id": "padding_bottom",
        "min": 0,
        "max": 100,
        "step": 2,
        "unit": "px",
        "label": "Padding Bottom",
        "default": 50
    }
  ]
}
{% endschema %}
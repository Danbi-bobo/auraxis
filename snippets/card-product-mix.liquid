{% comment %}
  Snippet: card-product-mix.liquid
  Features:
  - Custom Price (Saved amount)
  - No Add to cart button
  - FORCED SQUARE IMAGE (1:1 Aspect Ratio)
  - Hover effect (requires show_secondary_image: true)
{% endcomment %}

{%- if product and product != empty -%}
  {%- liquid
    # --- FIX: ÉP TỈ LỆ 1:1 (VUÔNG) ---
    assign ratio = 1 
  -%}

  <div class="card-wrapper product-card-wrapper underline-links-hover">
    <div
      class="
        card
        card--standard
        card--media
        {% if settings.card_style == 'card' %} color-{{ settings.card_color_scheme }} gradient{% endif %}
        {% if extend_height %} card--extend-height{% endif %}
        {% if product.media[1] != nil and show_secondary_image %} media--hover-effect{% endif %}
      "
      style="--ratio-percent: 100%;"
    >
      <div
        class="card__inner {% if settings.card_style == 'standard' %}color-{{ settings.card_color_scheme }} gradient{% endif %} ratio"
        style="--ratio-percent: 100%;"
      >
        {%- if product.featured_media -%}
          <div class="card__media">
            
            {% comment %} --- LOGIC ẢNH VUÔNG & HOVER --- {% endcomment %}
            <div class="media media--transparent media--hover-effect" style="padding-bottom: 100%; position: relative; display: block; width: 100%;">
              
              {% comment %} 1. Ảnh chính (Cắt giữa) {% endcomment %}
              <img
                src="{{ product.featured_media | image_url: width: 1024, height: 1024, crop: 'center' }}"
                alt="{{ product.featured_media.alt | escape }}"
                class="motion-reduce"
                loading="lazy"
                width="1024"
                height="1024"
                style="object-fit: cover; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;"
              >
              
              {% comment %} 2. Ảnh Hover (Chỉ hiện khi có lệnh show_secondary_image) {% endcomment %}
              {%- if product.media[1] != nil and show_secondary_image -%}
                <img
                  src="{{ product.media[1] | image_url: width: 1024, height: 1024, crop: 'center' }}"
                  alt="{{ product.media[1].alt | escape }}"
                  class="motion-reduce"
                  loading="lazy"
                  width="1024"
                  height="1024"
                  style="object-fit: cover; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; opacity: 0; transition: opacity 0.4s ease;"
                  onmouseover="this.style.opacity=1;"
                  onmouseout="this.style.opacity=0;"
                >
              {%- endif -%}
            </div>

          </div>
        {%- endif -%}

        <div class="card__content">
          <div class="card__badge {{ settings.badge_position }}">
            {%- if product.available == false -%}
              <span class="badge badge--bottom-left color-{{ settings.sold_out_badge_color_scheme }}">
                {{ 'products.product.sold_out' | t }}
              </span>
            {%- elsif product.compare_at_price > product.price -%}
              <span class="badge badge--bottom-left color-{{ settings.sale_badge_color_scheme }}">
                -{{ product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round }}%
              </span>
            {%- endif -%}
          </div>
        </div>
      </div>

      <div class="card__content">
        <div class="card__information">
          <h3 class="card__heading h5">
            <a href="{{ product.url }}" class="full-unstyled-link">
              {{ product.title | escape }}
            </a>
          </h3>

          <div class="card-information">
            <div class="price">
              <div class="price__container">
                {%- if product.compare_at_price > product.price -%}
                  <div class="price__sale">
                    <span class="price-item price-item--sale price-item--last" style="color: #B12704; font-weight: bold; font-size: 16px;">
                      {{ product.price | money }}
                    </span>
                    <span class="price-item price-item--regular" style="text-decoration: line-through; color: #565959; font-size: 13px; margin-left: 6px;">
                      {{ product.compare_at_price | money }}
                    </span>
                    <div class="price-saved" style="font-size: 12px; color: #B12704; margin-top: 4px; font-weight: 500;">
                      You save: {{ product.compare_at_price | minus: product.price | money }}
                    </div>
                  </div>
                {%- else -%}
                  <div class="price__regular">
                    <span class="price-item price-item--regular" style="font-weight: bold; font-size: 16px; color: #000;">
                      {{ product.price | money }}
                    </span>
                  </div>
                {%- endif -%}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{%- endif -%}